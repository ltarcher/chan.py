<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>缠论买卖点实时监控</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
        }
        
        .connection-status {
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .config-panel {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .config-panel h2 {
            margin-top: 0;
            color: #495057;
        }
        
        .config-item {
            margin-bottom: 10px;
        }
        
        .config-item label {
            display: inline-block;
            width: 150px;
            font-weight: bold;
        }
        
        .config-item input[type="checkbox"] {
            transform: scale(1.3);
            margin-right: 10px;
        }
        
        .dashboard-container {
            margin: 20px 0;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .dashboard-title {
            text-align: center;
            color: #333;
            margin-bottom: 15px;
        }
        
        .market-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 10px;
        }
        
        .market-card {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 10px;
            background-color: #fafafa;
            transition: all 0.3s ease;
            font-size: 13px;
        }
        
        .market-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .market-name {
            font-weight: bold;
            font-size: 15px;
            margin-bottom: 8px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        
        .market-data {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }
        
        .market-field {
            font-size: 12px;
            display: flex;
            justify-content: space-between;
        }
        
        .field-label {
            color: #666;
            margin-right: 5px;
        }
        
        .field-value {
            font-weight: bold;
            text-align: right;
        }
        
        .positive {
            color: #28a745;
        }
        
        .negative {
            color: #dc3545;
        }
        
        .signals-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        .signal-section {
            flex: 1;
        }
        
        .signal-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .signal-table th, .signal-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .signal-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        .signal-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .signal-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .buy-signal {
            color: #28a745;
            font-weight: bold;
        }
        
        .sell-signal {
            color: #dc3545;
            font-weight: bold;
        }
        
        .timestamp {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-connected {
            background-color: #28a745;
        }
        
        .status-disconnected {
            background-color: #dc3545;
        }
        
        @media (max-width: 768px) {
            .signals-container {
                flex-direction: column;
            }
            
            .config-item label {
                width: 120px;
            }
            
            .market-grid {
                grid-template-columns: 1fr;
            }
            
            .market-card {
                font-size: 12px;
            }
            
            .market-field {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>缠论买卖点实时监控</h1>
        
        <div id="connectionStatus" class="connection-status disconnected">
            WebSocket连接状态: <span class="status-indicator status-disconnected"></span> 未连接
        </div>
        
        <div class="config-panel">
            <h2>配置控制面板</h2>
            <div class="config-item">
                <label for="debugSwitch">调试模式:</label>
                <input type="checkbox" id="debugSwitch" onchange="updateWebSocketConfig('debug', this.checked)">
                <span id="debugStatus">关闭</span>
            </div>
            <div class="config-item">
                <label for="visualizationSwitch">可视化生成:</label>
                <input type="checkbox" id="visualizationSwitch" onchange="updateWebSocketConfig('generate_visualization', this.checked)" checked>
                <span id="visualizationStatus">开启</span>
            </div>
            <div class="config-item">
                <label for="messageSwitch">发送微信消息:</label>
                <input type="checkbox" id="messageSwitch" onchange="updateWebSocketConfig('send_wechat_message', this.checked)" checked>
                <span id="messageStatus">开启</span>
            </div>
        </div>
        
        <!-- 动态仪表盘 -->
        <div class="dashboard-container">
            <h2 class="dashboard-title">市场行情仪表盘</h2>
            <div class="market-grid" id="marketGrid">
                <!-- 行情卡片将在这里动态生成 -->
                <div class="no-data">暂无行情数据</div>
            </div>
        </div>
        
        <div class="signals-container">
            <div class="signal-section">
                <h2>新信号</h2>
                <table class="signal-table" id="newSignalsTable">
                    <thead>
                        <tr>
                            <th>时间</th>
                            <th>股票代码</th>
                            <th>级别</th>
                            <th>价格</th>
                            <th>信号类型</th>
                            <th>操作建议</th>
                        </tr>
                    </thead>
                    <tbody id="newSignalsBody">
                        <tr>
                            <td colspan="6" style="text-align: center;">暂无新信号</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="signal-section">
                <h2>消失信号</h2>
                <table class="signal-table" id="disappearedSignalsTable">
                    <thead>
                        <tr>
                            <th>时间</th>
                            <th>股票代码</th>
                            <th>级别</th>
                            <th>信号类型</th>
                            <th>操作建议</th>
                            <th>原因</th>
                        </tr>
                    </thead>
                    <tbody id="disappearedSignalsBody">
                        <tr>
                            <td colspan="6" style="text-align: center;">暂无消失信号</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        class ChanWebSocketClient {
            constructor() {
                this.ws = null;
                this.isConnected = false;
                this.newSignals = [];
                this.disappearedSignals = [];
                this.marketData = {}; // 存储行情数据
                this.maxSignals = 100; // 最大保存信号数量
                this.init();
            }
            
            init() {
                this.connect();
                // 每30秒尝试重连一次
                setInterval(() => {
                    if (!this.isConnected) {
                        this.connect();
                    }
                }, 30000);
            }
            
            connect() {
                try {
                    // 尝试连接到本地WebSocket服务器
                    this.ws = new WebSocket('ws://localhost:8765');
                    
                    this.ws.onopen = (event) => {
                        console.log('WebSocket连接已建立');
                        this.isConnected = true;
                        this.updateConnectionStatus(true);
                    };
                    
                    this.ws.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            this.handleMessage(data);
                        } catch (error) {
                            console.error('解析WebSocket消息失败:', error);
                        }
                    };
                    
                    this.ws.onclose = (event) => {
                        console.log('WebSocket连接已关闭');
                        this.isConnected = false;
                        this.updateConnectionStatus(false);
                    };
                    
                    this.ws.onerror = (error) => {
                        console.error('WebSocket错误:', error);
                        this.isConnected = false;
                        this.updateConnectionStatus(false);
                    };
                } catch (error) {
                    console.error('WebSocket连接失败:', error);
                    this.updateConnectionStatus(false);
                }
            }
            
            updateConnectionStatus(connected) {
                const statusElement = document.getElementById('connectionStatus');
                const indicator = statusElement.querySelector('.status-indicator');
                if (connected) {
                    statusElement.className = 'connection-status connected';
                    indicator.className = 'status-indicator status-connected';
                    statusElement.innerHTML = 'WebSocket连接状态: <span class="status-indicator status-connected"></span> 已连接';
                } else {
                    statusElement.className = 'connection-status disconnected';
                    indicator.className = 'status-indicator status-disconnected';
                    statusElement.innerHTML = 'WebSocket连接状态: <span class="status-indicator status-disconnected"></span> 未连接';
                }
            }
            
            handleMessage(data) {
                if (data.type === 'bsp_signal_update') {
                    // 处理新信号
                    if (data.new_signals && data.new_signals.length > 0) {
                        data.new_signals.forEach(signal => {
                            const signalData = {
                                timestamp: new Date().toLocaleString('zh-CN'),
                                code: data.code,
                                level: signal.level,
                                price: signal.price,
                                bsp_type: Array.isArray(signal.bsp_type) ? signal.bsp_type.join(', ') : signal.bsp_type,
                                operation: signal.operation,
                                is_buy: signal.is_buy
                            };
                            this.newSignals.unshift(signalData); // 添加到数组开头
                        });
                        this.newSignals = this.newSignals.slice(0, this.maxSignals); // 限制数量
                        this.updateNewSignalsTable();
                    }
                    
                    // 处理消失信号
                    if (data.disappeared_signals && data.disappeared_signals.length > 0) {
                        data.disappeared_signals.forEach(signal => {
                            const signalData = {
                                timestamp: new Date().toLocaleString('zh-CN'),
                                code: signal.code,
                                level: signal.level,
                                bsp_type: signal.bsp_type,
                                operation: signal.operation,
                                is_buy: signal.is_buy,
                                reason: signal.reason
                            };
                            this.disappearedSignals.unshift(signalData); // 添加到数组开头
                        });
                        this.disappearedSignals = this.disappearedSignals.slice(0, this.maxSignals); // 限制数量
                        this.updateDisappearedSignalsTable();
                    }
                } else if (data.type === 'market_data_update') {
                    // 处理行情数据更新
                    if (data.data) {
                        // 更新内部存储的行情数据
                        data.data.forEach(item => {
                            // 使用代码作为键值存储数据
                            const code = item.code || item.代码 || '';
                            this.marketData[code] = {
                                ...item,
                                timestamp: data.timestamp
                            };
                        });
                        
                        // 更新仪表盘显示
                        this.updateMarketDashboard();
                    }
                }
            }
            
            // 更新市场行情仪表盘
            updateMarketDashboard() {
                const marketGrid = document.getElementById('marketGrid');
                
                // 清空现有内容
                marketGrid.innerHTML = '';
                
                // 如果没有数据，显示提示信息
                if (Object.keys(this.marketData).length === 0) {
                    marketGrid.innerHTML = '<div class="no-data">暂无行情数据</div>';
                    return;
                }
                
                // 为每个市场数据创建卡片
                for (const code in this.marketData) {
                    const item = this.marketData[code];
                    const card = document.createElement('div');
                    card.className = 'market-card';
                    
                    // 判断涨跌颜色
                    const changeClass = (item.change_percent || item.涨幅 || 0) >= 0 ? 'positive' : 'negative';
                    const changeAmount = item.change_amount || ((item.price || item.最新 || 0) - (item.previous_close || item.昨收 || 0)) || 0;
                    
                    // 构造所有字段的展示内容
                    card.innerHTML = `
                        <div class="market-name">${item.name || item.名称 || ''} (${item.code || item.代码 || ''})</div>
                        <div class="market-data">
                            <div class="market-field">
                                <span class="field-label">最新价:</span>
                                <span class="field-value ${changeClass}">${(item.price || item.最新 || 0).toFixed(2)}</span>
                            </div>
                            <div class="market-field">
                                <span class="field-label">涨跌幅:</span>
                                <span class="field-value ${changeClass}">${(item.change_percent || item.涨幅 || 0) >= 0 ? '+' : ''}${(item.change_percent || item.涨幅 || 0).toFixed(2)}%</span>
                            </div>
                            <div class="market-field">
                                <span class="field-label">涨跌额:</span>
                                <span class="field-value ${changeClass}">${changeAmount >= 0 ? '+' : ''}${changeAmount.toFixed(2)}</span>
                            </div>
                            <div class="market-field">
                                <span class="field-label">最高价:</span>
                                <span class="field-value">${(item.high || item.最高 || 0).toFixed(2)}</span>
                            </div>
                            <div class="market-field">
                                <span class="field-label">最低价:</span>
                                <span class="field-value">${(item.low || item.最低 || 0).toFixed(2)}</span>
                            </div>
                            <div class="market-field">
                                <span class="field-label">今开:</span>
                                <span class="field-value">${(item.open || item.今开 || 0).toFixed(2)}</span>
                            </div>
                            <div class="market-field">
                                <span class="field-label">昨收:</span>
                                <span class="field-value">${(item.previous_close || item.昨收 || 0).toFixed(2)}</span>
                            </div>
                            <div class="market-field">
                                <span class="field-label">换手率:</span>
                                <span class="field-value">${(item.turnover_rate || item.换手率 || item.换手率 || 0).toFixed(2)}%</span>
                            </div>
                            <div class="market-field">
                                <span class="field-label">量比:</span>
                                <span class="field-value">${(item.volume_ratio || item.量比 || 0).toFixed(2)}</span>
                            </div>
                            <div class="market-field">
                                <span class="field-label">市盈率:</span>
                                <span class="field-value">${(item.pe_ratio || item.市盈率 || 0).toFixed(2)}</span>
                            </div>
                            <div class="market-field">
                                <span class="field-label">成交量:</span>
                                <span class="field-value">${Math.round((item.volume || item.成交量 || 0) / 10000).toLocaleString()}手</span>
                            </div>
                            <div class="market-field">
                                <span class="field-label">成交额:</span>
                                <span class="field-value">¥${Math.round((item.amount || item.成交额 || 0) / 100000000).toLocaleString()}亿</span>
                            </div>
                            <div class="market-field">
                                <span class="field-label">总市值:</span>
                                <span class="field-value">¥${Math.round((item.market_cap || item.总市值 || 0) / 100000000).toLocaleString()}亿</span>
                            </div>
                            <div class="market-field">
                                <span class="field-label">流通市值:</span>
                                <span class="field-value">¥${Math.round((item.circulating_market_cap || item.流通市值 || 0) / 100000000).toLocaleString()}亿</span>
                            </div>
                            <div class="market-field">
                                <span class="field-label">市场:</span>
                                <span class="field-value">${item.market || item.市场 || ''}</span>
                            </div>
                            <div class="market-field">
                                <span class="field-label">时间:</span>
                                <span class="field-value">${item.time || item.时间 || ''}</span>
                            </div>
                        </div>
                    `;
                    
                    marketGrid.appendChild(card);
                }
            }
            
            updateNewSignalsTable() {
                const tbody = document.getElementById('newSignalsBody');
                if (this.newSignals.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">暂无新信号</td></tr>';
                    return;
                }
                
                tbody.innerHTML = '';
                this.newSignals.forEach(signal => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="timestamp">${signal.timestamp}</td>
                        <td>${signal.code}</td>
                        <td>${signal.level}</td>
                        <td>${signal.price}</td>
                        <td>${signal.bsp_type}</td>
                        <td class="${signal.is_buy ? 'buy-signal' : 'sell-signal'}">
                            ${signal.operation}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            updateDisappearedSignalsTable() {
                const tbody = document.getElementById('disappearedSignalsBody');
                if (this.disappearedSignals.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">暂无消失信号</td></tr>';
                    return;
                }
                
                tbody.innerHTML = '';
                this.disappearedSignals.forEach(signal => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="timestamp">${signal.timestamp}</td>
                        <td>${signal.code}</td>
                        <td>${signal.level}</td>
                        <td>${signal.bsp_type}</td>
                        <td class="${signal.is_buy ? 'buy-signal' : 'sell-signal'}">
                            ${signal.operation}
                        </td>
                        <td>${signal.reason}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            // 发送配置更新到服务器
            sendConfigUpdate(config) {
                if (this.isConnected && this.ws.readyState === WebSocket.OPEN) {
                    const message = JSON.stringify({
                        type: "config_update",
                        ...config
                    });
                    this.ws.send(message);
                }
            }
        }
        
        // 更新WebSocket配置函数
        function updateWebSocketConfig(key, value) {
            // 更新UI状态显示
            const statusElement = document.getElementById(key + 'Status');
            if (statusElement) {
                statusElement.textContent = value ? '开启' : '关闭';
            }
            
            // 发送配置更新到服务器
            if (window.client) {
                const config = {};
                config[key] = value;
                window.client.sendConfigUpdate(config);
            }
        }
        
        // 页面加载完成后初始化WebSocket客户端
        document.addEventListener('DOMContentLoaded', () => {
            window.client = new ChanWebSocketClient();
        });
    </script>
</body>
</html>