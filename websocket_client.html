<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>缠论买卖点实时监控</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
        }
        
        .connection-status {
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .config-panel {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .config-panel h2 {
            margin-top: 0;
            color: #495057;
        }
        
        .config-item {
            margin-bottom: 10px;
        }
        
        .config-item label {
            display: inline-block;
            width: 150px;
            font-weight: bold;
        }
        
        .config-item input[type="checkbox"] {
            transform: scale(1.3);
            margin-right: 10px;
        }
        
        .dashboard-container {
            margin: 20px 0;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .dashboard-title {
            text-align: center;
            color: #333;
            margin-bottom: 15px;
        }
        
        .view-toggle {
            text-align: right;
            margin-bottom: 10px;
        }
        
        .view-toggle button {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #495057;
            padding: 5px 10px;
            margin-left: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .view-toggle button.active {
            background-color: #007bff;
            color: white;
        }
        
        .market-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 10px;
        }
        
        .market-card {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 10px;
            background-color: #fafafa;
            transition: all 0.3s ease;
            font-size: 13px;
        }
        
        .market-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .market-name {
            font-weight: bold;
            font-size: 15px;
            margin-bottom: 8px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        
        .market-data {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }
        
        .market-field {
            font-size: 12px;
            display: flex;
            justify-content: space-between;
        }
        
        .field-label {
            color: #666;
            margin-right: 5px;
        }
        
        .field-value {
            font-weight: bold;
            text-align: right;
        }
        
        .positive {
            color: #dc3545; /* 红色 */
        }
        
        .negative {
            color: #28a745; /* 绿色 */
        }
        
        /* 列表模式样式 */
        .market-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .market-table th, .market-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: right;
        }
        
        .market-table th {
            background-color: #f2f2f2;
            font-weight: bold;
            text-align: center;
        }
        
        .market-table th:first-child, .market-table td:first-child {
            text-align: left;
        }
        
        .market-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .market-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .market-table .positive {
            color: #dc3545; /* 红色 */
        }
        
        .market-table .negative {
            color: #28a745; /* 绿色 */
        }
        
        .signals-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        .signal-section {
            flex: 1;
        }
        
        .signal-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .signal-table th, .signal-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .signal-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        .signal-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .signal-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .buy-signal {
            color: #28a745;
            font-weight: bold;
        }
        
        .sell-signal {
            color: #dc3545;
            font-weight: bold;
        }
        
        .timestamp {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-connected {
            background-color: #28a745;
        }
        
        .tab-container {
            margin-top: 20px;
        }
        
        .tab-header {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .tab-button {
            padding: 8px 16px;
            border: 1px solid #dee2e6;
            background-color: #f8f9fa;
            color: #495057;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .tab-button:hover {
            background-color: #e9ecef;
        }
        
        .tab-button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .status-disconnected {
            background-color: #dc3545;
        }
        
        @media (max-width: 768px) {
            .signals-container {
                flex-direction: column;
            }
            
            .config-item label {
                width: 120px;
            }
            
            .market-grid {
                grid-template-columns: 1fr;
            }
            
            .market-card {
                font-size: 12px;
            }
            
            .market-field {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>缠论买卖点实时监控</h1>
        
        <div id="connectionStatus" class="connection-status disconnected">
            WebSocket连接状态: <span class="status-indicator status-disconnected"></span> 未连接
        </div>
        
        <!-- 标签页 -->
        <div class="tab-container">
            <div class="tab-header">
                <div class="tab-button active" onclick="switchTab('market')">市场行情</div>
                <div class="tab-button" onclick="switchTab('signals')">信号</div>
                <div class="tab-button" onclick="switchTab('options')">期权波动率</div>
                <div class="tab-button" onclick="switchTab('config')">配置控制面板</div>
            </div>
            
            <!-- 市场行情标签页 -->
            <div id="market-tab" class="tab-content active">
                <!-- 动态仪表盘 -->
                <div class="dashboard-container">
                    <h2 class="dashboard-title">市场行情仪表盘</h2>
                    <div class="view-toggle">
                        <button id="cardViewBtn" class="active" onclick="switchView('card')">卡片模式</button>
                        <button id="listViewBtn" onclick="switchView('list')">列表模式</button>
                    </div>
                    <div class="market-grid" id="marketGrid">
                        <!-- 行情卡片将在这里动态生成 -->
                        <div class="no-data">暂无行情数据</div>
                    </div>
                    <div id="marketTableContainer" style="display: none;">
                        <table class="market-table" id="marketTable">
                            <thead>
                                <tr>
                                    <th>名称(代码)</th>
                                    <th>最新价</th>
                                    <th>涨跌幅</th>
                                    <th>涨跌额</th>
                                    <th>最高价</th>
                                    <th>最低价</th>
                                    <th>今开</th>
                                    <th>昨收</th>
                                    <th>换手率</th>
                                    <th>量比</th>
                                    <th>市盈率</th>
                                    <th>成交量(手)</th>
                                    <th>成交额(亿)</th>
                                    <th>总市值(亿)</th>
                                    <th>流通市值(亿)</th>
                                    <th>市场</th>
                                    <th>时间</th>
                                </tr>
                            </thead>
                            <tbody id="marketTableBody">
                                <!-- 行情列表将在这里动态生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- 信号标签页 -->
            <div id="signals-tab" class="tab-content">
                <div class="signals-container">
                    <div class="signal-section">
                        <h2>新信号</h2>
                        <table class="signal-table" id="newSignalsTable">
                            <thead>
                                <tr>
                                    <th>时间</th>
                                    <th>股票代码</th>
                                    <th>级别</th>
                                    <th>价格</th>
                                    <th>信号类型</th>
                                    <th>操作建议</th>
                                </tr>
                            </thead>
                            <tbody id="newSignalsBody">
                                <tr>
                                    <td colspan="6" style="text-align: center;">暂无新信号</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="signal-section">
                        <h2>消失信号</h2>
                        <table class="signal-table" id="disappearedSignalsTable">
                            <thead>
                                <tr>
                                    <th>时间</th>
                                    <th>股票代码</th>
                                    <th>级别</th>
                                    <th>信号类型</th>
                                    <th>操作建议</th>
                                    <th>原因</th>
                                </tr>
                            </thead>
                            <tbody id="disappearedSignalsBody">
                                <tr>
                                    <td colspan="6" style="text-align: center;">暂无消失信号</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- 配置控制面板标签页 -->
            <div id="config-tab" class="tab-content">
                <div class="config-panel">
                    <h2>配置控制面板</h2>
                    <div class="config-item">
                        <label for="debugSwitch">调试模式:</label>
                        <input type="checkbox" id="debugSwitch" onchange="updateWebSocketConfig('debug', this.checked)">
                        <span id="debugStatus">关闭</span>
                    </div>
                    <div class="config-item">
                        <label for="visualizationSwitch">可视化生成:</label>
                        <input type="checkbox" id="visualizationSwitch" onchange="updateWebSocketConfig('generate_visualization', this.checked)" checked>
                        <span id="visualizationStatus">开启</span>
                    </div>
                    <div class="config-item">
                        <label for="messageSwitch">发送微信消息:</label>
                        <input type="checkbox" id="messageSwitch" onchange="updateWebSocketConfig('send_wechat_message', this.checked)" checked>
                        <span id="messageStatus">开启</span>
                    </div>
                </div>
            </div>
            
            <!-- 期权波动率标签页 -->
            <div id="options-tab" class="tab-content">
                <div class="dashboard-container">
                    <h2 class="dashboard-title">期权波动率指数</h2>
                    <div class="view-toggle">
                        <button id="optionsCardViewBtn" class="active" onclick="switchOptionsView('card')">卡片模式</button>
                        <button id="optionsListViewBtn" onclick="switchOptionsView('list')">列表模式</button>
                    </div>
                    <div class="market-grid" id="optionsGrid">
                        <!-- 期权波动率数据将在这里动态生成 -->
                        <div class="no-data">暂无期权波动率数据</div>
                    </div>
                    <div id="optionsTableContainer" style="display: none;">
                        <table class="market-table" id="optionsTable">
                            <thead>
                                <tr>
                                    <th>名称</th>
                                    <th>最新值</th>
                                    <th>涨跌幅</th>
                                    <th>日线数据点</th>
                                    <th>分钟线数据点</th>
                                    <th>时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="optionsTableBody">
                                <!-- 期权波动率列表将在这里动态生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="options-debug-info"></div> <!-- 调试信息显示区域 -->
            </div>
        </div>
    </div>

    <script>
        // 当前视图模式 ('card' 或 'list')
        let currentView = 'card';
        let currentOptionsView = 'card';
        
        // 切换标签页
        function switchTab(tabName) {
            // 隐藏所有标签页内容
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 移除所有标签按钮的active类
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // 显示选中的标签页
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // 为点击的标签按钮添加active类
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }
        }
        
        // 切换视图模式
        function switchView(view) {
            currentView = view;
            
            // 更新按钮状态
            document.getElementById('cardViewBtn').classList.toggle('active', view === 'card');
            document.getElementById('listViewBtn').classList.toggle('active', view === 'list');
            
            // 显示/隐藏对应视图
            document.getElementById('marketGrid').style.display = view === 'card' ? 'grid' : 'none';
            document.getElementById('marketTableContainer').style.display = view === 'list' ? 'block' : 'none';
            
            // 如果有数据，更新当前视图
            if (window.client && Object.keys(window.client.marketData).length > 0) {
                if (view === 'card') {
                    window.client.updateMarketDashboard();
                } else {
                    window.client.updateMarketTable();
                }
            }
        }
        
        // 切换期权波动率视图模式
        function switchOptionsView(view) {
            console.log('切换期权视图模式:', view); // 调试信息
            currentOptionsView = view;
            
            // 更新按钮状态
            document.getElementById('optionsCardViewBtn').classList.toggle('active', view === 'card');
            document.getElementById('optionsListViewBtn').classList.toggle('active', view === 'list');
            
            // 显示/隐藏对应视图
            document.getElementById('optionsGrid').style.display = view === 'card' ? 'grid' : 'none';
            document.getElementById('optionsTableContainer').style.display = view === 'list' ? 'block' : 'none';
            
            // 如果有数据，更新当前视图
            if (window.client && window.client.optionsData) {
                if (view === 'card') {
                    window.client.updateOptionsDashboard();
                } else {
                    window.client.updateOptionsTable();
                }
            }
        }
        
        // 显示期权波动率K线图
        function showOptionsChart(optionName) {
            if (window.client) {
                window.client.showOptionsChart(optionName);
            }
        }
        
        class ChanWebSocketClient {
            constructor() {
                this.ws = null;
                this.isConnected = false;
                this.newSignals = [];
                this.disappearedSignals = [];
                this.marketData = {}; // 存储行情数据
                this.optionsData = {}; // 存储期权波动率数据
                this.maxSignals = 100; // 最大保存信号数量
                console.log('初始化WebSocket客户端'); // 调试信息
                this.init();
            }
            
            init() {
                this.connect();
                // 每30秒尝试重连一次
                setInterval(() => {
                    if (!this.isConnected) {
                        this.connect();
                    }
                }, 30000);
            }
            
            // 清理包含无效值的数据
            cleanData(obj) {
                if (obj === null || obj === undefined) {
                    return null;
                }
                
                if (typeof obj === 'number') {
                    if (isNaN(obj) || !isFinite(obj)) {
                        return null;
                    }
                    return obj;
                }
                
                if (typeof obj === 'object') {
                    if (Array.isArray(obj)) {
                        return obj.map(item => this.cleanData(item));
                    } else {
                        const cleaned = {};
                        for (const key in obj) {
                            if (obj.hasOwnProperty(key)) {
                                cleaned[key] = this.cleanData(obj[key]);
                            }
                        }
                        return cleaned;
                    }
                }
                
                return obj;
            }
            
            connect() {
                try {
                    // 尝试连接到本地WebSocket服务器
                    this.ws = new WebSocket('ws://localhost:8765');
                    
                    this.ws.onopen = (event) => {
                        console.log('WebSocket连接已建立');
                        this.isConnected = true;
                        this.updateConnectionStatus(true);
                    };
                    
                    this.ws.onmessage = (event) => {
                        try {
                            // 解析JSON数据
                            let data = JSON.parse(event.data);
                            
                            // 清理数据中的NaN和Infinity值
                            data = this.cleanData(data);
                            
                            this.handleMessage(data);
                        } catch (error) {
                            console.error('解析WebSocket消息失败:', error);
                            console.error('原始数据:', event.data);
                        }
                    };
                    
                    this.ws.onclose = (event) => {
                        console.log('WebSocket连接已关闭');
                        this.isConnected = false;
                        this.updateConnectionStatus(false);
                    };
                    
                    this.ws.onerror = (error) => {
                        console.error('WebSocket错误:', error);
                        this.isConnected = false;
                        this.updateConnectionStatus(false);
                    };
                } catch (error) {
                    console.error('WebSocket连接失败:', error);
                    this.updateConnectionStatus(false);
                }
            }
            
            updateConnectionStatus(connected) {
                const statusElement = document.getElementById('connectionStatus');
                const indicator = statusElement.querySelector('.status-indicator');
                if (connected) {
                    statusElement.className = 'connection-status connected';
                    indicator.className = 'status-indicator status-connected';
                    statusElement.innerHTML = 'WebSocket连接状态: <span class="status-indicator status-connected"></span> 已连接';
                } else {
                    statusElement.className = 'connection-status disconnected';
                    indicator.className = 'status-indicator status-disconnected';
                    statusElement.innerHTML = 'WebSocket连接状态: <span class="status-indicator status-disconnected"></span> 未连接';
                }
            }
            
            handleMessage(data) {
                if (data.type === 'bsp_signal_update') {
                    // 处理新信号
                    if (data.new_signals && data.new_signals.length > 0) {
                        data.new_signals.forEach(signal => {
                            const signalData = {
                                timestamp: new Date().toLocaleString('zh-CN'),
                                code: data.code,
                                level: signal.level,
                                price: signal.price,
                                bsp_type: Array.isArray(signal.bsp_type) ? signal.bsp_type.join(', ') : signal.bsp_type,
                                operation: signal.operation,
                                is_buy: signal.is_buy
                            };
                            this.newSignals.unshift(signalData); // 添加到数组开头
                        });
                        this.newSignals = this.newSignals.slice(0, this.maxSignals); // 限制数量
                        this.updateNewSignalsTable();
                    }
                    
                    // 处理消失信号
                    if (data.disappeared_signals && data.disappeared_signals.length > 0) {
                        data.disappeared_signals.forEach(signal => {
                            const signalData = {
                                timestamp: new Date().toLocaleString('zh-CN'),
                                code: signal.code,
                                level: signal.level,
                                bsp_type: signal.bsp_type,
                                operation: signal.operation,
                                is_buy: signal.is_buy,
                                reason: signal.reason
                            };
                            this.disappearedSignals.unshift(signalData); // 添加到数组开头
                        });
                        this.disappearedSignals = this.disappearedSignals.slice(0, this.maxSignals); // 限制数量
                        this.updateDisappearedSignalsTable();
                    }
                } else if (data.type === 'market_data_update') {
                    // 处理行情数据更新
                    if (data.data) {
                        // 更新内部存储的行情数据
                        data.data.forEach(item => {
                            // 使用代码作为键值存储数据
                            const code = item.code || item.代码 || '';
                            this.marketData[code] = {
                                ...item,
                                timestamp: data.timestamp
                            };
                        });
                        
                        // 更新仪表盘显示
                        if (currentView === 'card') {
                            this.updateMarketDashboard();
                        } else {
                            this.updateMarketTable();
                        }
                    }
                } else if (data.type === 'options_data_update') {
                    // 处理期权波动率数据更新
                    console.log('收到期权波动率数据:', data); // 调试信息
                    if (data.data) {
                        // 更新内部存储的期权波动率数据
                        this.optionsData = {};
                        data.data.forEach(item => {
                            // 使用名称作为键值存储数据
                            const name = item.name || '';
                            this.optionsData[name] = item;
                        });
                        console.log('处理后的期权数据:', this.optionsData); // 调试信息
                        
                        // 更新期权波动率仪表盘显示
                        if (currentOptionsView === 'card') {
                            this.updateOptionsDashboard();
                        } else {
                            this.updateOptionsTable();
                        }
                        
                        // 如果在K线图视图，更新K线图
                        if (this.currentOptionsChart) {
                            this.updateOptionsChart();
                        }
                    }
                }
            }
            
            // 更新市场行情仪表盘（卡片模式）
            updateMarketDashboard() {
                const marketGrid = document.getElementById('marketGrid');
                
                // 清空现有内容
                marketGrid.innerHTML = '';
                
                // 如果没有数据，显示提示信息
                if (Object.keys(this.marketData).length === 0) {
                    marketGrid.innerHTML = '<div class="no-data">暂无行情数据</div>';
                    return;
                }
                
                // 为每个市场数据创建卡片
                for (const code in this.marketData) {
                    const item = this.marketData[code];
                    const card = document.createElement('div');
                    card.className = 'market-card';
                    
                    // 判断涨跌颜色 - 涨红跌绿
                    const changeClass = (item.change_percent || item.涨幅 || 0) >= 0 ? 'positive' : 'negative';
                    const changeAmount = item.change_amount || ((item.price || item.最新 || 0) - (item.previous_close || item.昨收 || 0)) || 0;
                    
                    // 构造所有字段的展示内容
                    card.innerHTML = `
                        <div class="market-name">${item.name || item.名称 || ''} (${item.code || item.代码 || ''})</div>
                        <div class="market-data">
                            <div class="market-field">
                                <span class="field-label">最新价:</span>
                                <span class="field-value ${changeClass}">${(item.price || item.最新 || 0).toFixed(2)}</span>
                            </div>
                            <div class="market-field">
                                <span class="field-label">涨跌幅:</span>
                                <span class="field-value ${changeClass}">${(item.change_percent || item.涨幅 || 0) >= 0 ? '+' : ''}${(item.change_percent || item.涨幅 || 0).toFixed(2)}%</span>
                            </div>
                            <div class="market-field">
                                <span class="field-label">涨跌额:</span>
                                <span class="field-value ${changeClass}">${changeAmount >= 0 ? '+' : ''}${changeAmount.toFixed(2)}</span>
                            </div>
                            <div class="market-field">
                                <span class="field-label">最高价:</span>
                                <span class="field-value">${(item.high || item.最高 || 0).toFixed(2)}</span>
                            </div>
                            <div class="market-field">
                                <span class="field-label">最低价:</span>
                                <span class="field-value">${(item.low || item.最低 || 0).toFixed(2)}</span>
                            </div>
                            <div class="market-field">
                                <span class="field-label">今开:</span>
                                <span class="field-value">${(item.open || item.今开 || 0).toFixed(2)}</span>
                            </div>
                            <div class="market-field">
                                <span class="field-label">昨收:</span>
                                <span class="field-value">${(item.previous_close || item.昨收 || 0).toFixed(2)}</span>
                            </div>
                            <div class="market-field">
                                <span class="field-label">换手率:</span>
                                <span class="field-value">${(item.turnover_rate || item.换手率 || item.换手率 || 0).toFixed(2)}%</span>
                            </div>
                            <div class="market-field">
                                <span class="field-label">量比:</span>
                                <span class="field-value">${(item.volume_ratio || item.量比 || 0).toFixed(2)}</span>
                            </div>
                            <div class="market-field">
                                <span class="field-label">市盈率:</span>
                                <span class="field-value">${(item.pe_ratio || item.市盈率 || 0).toFixed(2)}</span>
                            </div>
                            <div class="market-field">
                                <span class="field-label">成交量:</span>
                                <span class="field-value">${Math.round((item.volume || item.成交量 || 0) / 10000).toLocaleString()}手</span>
                            </div>
                            <div class="market-field">
                                <span class="field-label">成交额:</span>
                                <span class="field-value">¥${Math.round((item.amount || item.成交额 || 0) / 100000000).toLocaleString()}亿</span>
                            </div>
                            <div class="market-field">
                                <span class="field-label">总市值:</span>
                                <span class="field-value">¥${Math.round((item.market_cap || item.总市值 || 0) / 100000000).toLocaleString()}亿</span>
                            </div>
                            <div class="market-field">
                                <span class="field-label">流通市值:</span>
                                <span class="field-value">¥${Math.round((item.circulating_market_cap || item.流通市值 || 0) / 100000000).toLocaleString()}亿</span>
                            </div>
                            <div class="market-field">
                                <span class="field-label">市场:</span>
                                <span class="field-value">${item.market || item.市场 || ''}</span>
                            </div>
                            <div class="market-field">
                                <span class="field-label">时间:</span>
                                <span class="field-value">${item.time || item.时间 || ''}</span>
                            </div>
                        </div>
                    `;
                    
                    marketGrid.appendChild(card);
                }
            }
            
            // 更新市场行情表格（列表模式）
            updateMarketTable() {
                const tableBody = document.getElementById('marketTableBody');
                
                // 清空现有内容
                tableBody.innerHTML = '';
                
                // 如果没有数据，显示提示信息
                if (Object.keys(this.marketData).length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="17" style="text-align: center;">暂无行情数据</td>`;
                    tableBody.appendChild(row);
                    return;
                }
                
                // 为每个市场数据创建表格行
                for (const code in this.marketData) {
                    const item = this.marketData[code];
                    
                    // 判断涨跌颜色 - 涨红跌绿
                    const changeClass = (item.change_percent || item.涨幅 || 0) >= 0 ? 'positive' : 'negative';
                    const changeAmount = item.change_amount || ((item.price || item.最新 || 0) - (item.previous_close || item.昨收 || 0)) || 0;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.name || item.名称 || ''} (${item.code || item.代码 || ''})</td>
                        <td class="${changeClass}">${(item.price || item.最新 || 0).toFixed(2)}</td>
                        <td class="${changeClass}">${(item.change_percent || item.涨幅 || 0) >= 0 ? '+' : ''}${(item.change_percent || item.涨幅 || 0).toFixed(2)}%</td>
                        <td class="${changeClass}">${changeAmount >= 0 ? '+' : ''}${changeAmount.toFixed(2)}</td>
                        <td>${(item.high || item.最高 || 0).toFixed(2)}</td>
                        <td>${(item.low || item.最低 || 0).toFixed(2)}</td>
                        <td>${(item.open || item.今开 || 0).toFixed(2)}</td>
                        <td>${(item.previous_close || item.昨收 || 0).toFixed(2)}</td>
                        <td>${(item.turnover_rate || item.换手率 || item.换手率 || 0).toFixed(2)}%</td>
                        <td>${(item.volume_ratio || item.量比 || 0).toFixed(2)}</td>
                        <td>${(item.pe_ratio || item.市盈率 || 0).toFixed(2)}</td>
                        <td>${Math.round((item.volume || item.成交量 || 0) / 10000).toLocaleString()}</td>
                        <td>¥${Math.round((item.amount || item.成交额 || 0) / 100000000).toLocaleString()}</td>
                        <td>¥${Math.round((item.market_cap || item.总市值 || 0) / 100000000).toLocaleString()}</td>
                        <td>¥${Math.round((item.circulating_market_cap || item.流通市值 || 0) / 100000000).toLocaleString()}</td>
                        <td>${item.market || item.市场 || ''}</td>
                        <td>${item.time || item.时间 || ''}</td>
                    `;
                    
                    tableBody.appendChild(row);
                }
            }
            
            // 更新期权波动率仪表盘（卡片模式）
            updateOptionsDashboard() {
                const optionsGrid = document.getElementById('optionsGrid');
                console.log('更新期权波动率仪表盘，数据:', this.optionsData); // 调试信息
                
                // 清空现有内容
                optionsGrid.innerHTML = '';
                
                // 如果没有数据，显示提示信息
                if (Object.keys(this.optionsData).length === 0) {
                    optionsGrid.innerHTML = '<div class="no-data">暂无期权波动率数据</div>';
                    return;
                }
                
                // 为每个期权波动率数据创建卡片
                for (const name in this.optionsData) {
                    const item = this.optionsData[name];
                    console.log('处理期权项目:', name, item); // 调试信息
                    const card = document.createElement('div');
                    card.className = 'market-card';
                    
                    // 获取最新数据点
                    let latestData = null;
                    let changePercent = 0;
                    let isDayData = false;
                    
                    // 优先使用日线数据计算涨跌幅，如果没有则使用分钟线数据
                    if (item.day_data && item.day_data.length > 0) {
                        const dayData = item.day_data;
                        latestData = dayData[dayData.length - 1];
                        if (dayData.length > 1) {
                            const prevData = dayData[dayData.length - 2];
                            if (prevData.close !== 0) {
                                changePercent = ((latestData.close - prevData.close) / prevData.close) * 100;
                            }
                        }
                        isDayData = true;
                    } else if (item.min_data && item.min_data.length > 0) {
                        const minData = item.min_data;
                        latestData = minData[minData.length - 1];
                        if (minData.length > 1) {
                            const prevData = minData[minData.length - 2];
                            if (prevData.qvix !== 0) {
                                changePercent = ((latestData.qvix - prevData.qvix) / prevData.qvix) * 100;
                            }
                        }
                    }
                    
                    // 判断涨跌颜色 - 涨红跌绿
                    const changeClass = (changePercent || 0) >= 0 ? 'positive' : 'negative';
                    const latestValue = isDayData ? (latestData ? latestData.close : 0) : (latestData ? latestData.qvix : 0);
                    
                    // 构造所有字段的展示内容
                    card.innerHTML = `
                        <div class="market-name">${item.name || ''}</div>
                        <div class="market-data">
                            <div class="market-field">
                                <span class="field-label">最新值:</span>
                                <span class="field-value ${changeClass}">${latestValue.toFixed(2)}</span>
                            </div>
                            <div class="market-field">
                                <span class="field-label">涨跌幅:</span>
                                <span class="field-value ${changeClass}">${(changePercent || 0) >= 0 ? '+' : ''}${(changePercent || 0).toFixed(2)}%</span>
                            </div>
                            <div class="market-field">
                                <span class="field-label">日线数据:</span>
                                <span class="field-value">${item.day_data ? item.day_data.length : 0} 点</span>
                            </div>
                            <div class="market-field">
                                <span class="field-label">分钟线:</span>
                                <span class="field-value">${item.min_data ? item.min_data.length : 0} 点</span>
                            </div>
                            <div class="market-field">
                                <span class="field-label">时间:</span>
                                <span class="field-value">${latestData ? (isDayData ? latestData.date : latestData.time) : ''}</span>
                            </div>
                            <div class="market-field">
                                <button onclick="showOptionsChart('${name.replace(/'/g, "\\'")}')">查看K线图</button>
                            </div>
                        </div>
                    `;
                    
                    optionsGrid.appendChild(card);
                }
            }
            
            // 更新期权波动率表格（列表模式）
            updateOptionsTable() {
                const tableBody = document.getElementById('optionsTableBody');
                console.log('更新期权波动率表格，数据:', this.optionsData); // 调试信息
                
                // 清空现有内容
                tableBody.innerHTML = '';
                
                // 如果没有数据，显示提示信息
                if (Object.keys(this.optionsData).length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="7" style="text-align: center;">暂无期权波动率数据</td>`;
                    tableBody.appendChild(row);
                    return;
                }
                
                // 为每个期权波动率数据创建表格行
                for (const name in this.optionsData) {
                    const item = this.optionsData[name];
                    console.log('处理期权表格项目:', name, item); // 调试信息
                    
                    // 获取最新数据点
                    let latestData = null;
                    let changePercent = 0;
                    let isDayData = false;
                    
                    // 优先使用日线数据计算涨跌幅，如果没有则使用分钟线数据
                    if (item.day_data && item.day_data.length > 0) {
                        const dayData = item.day_data;
                        latestData = dayData[dayData.length - 1];
                        if (dayData.length > 1) {
                            const prevData = dayData[dayData.length - 2];
                            if (prevData.close !== 0) {
                                changePercent = ((latestData.close - prevData.close) / prevData.close) * 100;
                            }
                        }
                        isDayData = true;
                    } else if (item.min_data && item.min_data.length > 0) {
                        const minData = item.min_data;
                        latestData = minData[minData.length - 1];
                        if (minData.length > 1) {
                            const prevData = minData[minData.length - 2];
                            if (prevData.qvix !== 0) {
                                changePercent = ((latestData.qvix - prevData.qvix) / prevData.qvix) * 100;
                            }
                        }
                    }
                    
                    // 判断涨跌颜色 - 涨红跌绿
                    const changeClass = (changePercent || 0) >= 0 ? 'positive' : 'negative';
                    const latestValue = isDayData ? (latestData ? latestData.close : 0) : (latestData ? latestData.qvix : 0);
                    const timeValue = latestData ? (isDayData ? latestData.date : latestData.time) : '';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.name || ''}</td>
                        <td class="${changeClass}">${latestValue.toFixed(2)}</td>
                        <td class="${changeClass}">${(changePercent || 0) >= 0 ? '+' : ''}${(changePercent || 0).toFixed(2)}%</td>
                        <td>${item.day_data ? item.day_data.length : 0}</td>
                        <td>${item.min_data ? item.min_data.length : 0}</td>
                        <td>${timeValue}</td>
                        <td><button onclick="showOptionsChart('${name.replace(/'/g, "\\'")}')">查看K线图</button></td>
                    `;
                    
                    tableBody.appendChild(row);
                }
            }
            
            // 显示期权波动率K线图
            showOptionsChart(optionName) {
                const item = this.optionsData[optionName];
                if (!item) return;
                
                // 创建或更新图表容器
                let chartContainer = document.getElementById('optionsChartContainer');
                if (!chartContainer) {
                    chartContainer = document.createElement('div');
                    chartContainer.id = 'optionsChartContainer';
                    chartContainer.style.marginTop = '20px';
                    chartContainer.style.height = '500px';
                    document.getElementById('options-tab').appendChild(chartContainer);
                }
                
                // 绘制K线图
                this.drawOptionsChart(chartContainer, item, optionName);
                
                // 记录当前显示图表的期权
                this.currentOptionsChart = optionName;
            }
            
            // 绘制期权波动率K线图
            drawOptionsChart(container, item, optionName) {
                // 清空容器
                container.innerHTML = '';
                
                // 创建图表标题
                const title = document.createElement('h3');
                title.textContent = `${optionName} 波动率K线图`;
                title.style.textAlign = 'center';
                container.appendChild(title);
                
                // 如果没有数据，显示提示信息
                if ((!item.min_data || item.min_data.length === 0) && 
                    (!item.day_data || item.day_data.length === 0)) {
                    const noData = document.createElement('div');
                    noData.textContent = '暂无数据';
                    noData.style.textAlign = 'center';
                    noData.style.padding = '50px';
                    container.appendChild(noData);
                    return;
                }
                
                // 创建选项卡用于切换日线和分钟线
                const tabContainer = document.createElement('div');
                tabContainer.style.marginBottom = '10px';
                
                const dayTab = document.createElement('button');
                dayTab.textContent = '日线数据';
                dayTab.onclick = () => this.switchChartType(container, item, optionName, 'day');
                dayTab.style.marginRight = '5px';
                
                const minTab = document.createElement('button');
                minTab.textContent = '分钟线数据';
                minTab.onclick = () => this.switchChartType(container, item, optionName, 'min');
                minTab.style.marginRight = '5px';
                
                tabContainer.appendChild(dayTab);
                tabContainer.appendChild(minTab);
                container.appendChild(tabContainer);
                
                // 默认显示日线数据
                this.renderChartContent(container, item, 'day');
            }
            
            // 切换图表类型
            switchChartType(container, item, optionName, type) {
                // 清除之前的内容（保留标题和选项卡）
                while (container.children.length > 2) {
                    container.removeChild(container.lastChild);
                }
                
                // 显示对应类型的数据
                this.renderChartContent(container, item, type);
            }
            
            // 渲染图表内容
            renderChartContent(container, item, type) {
                const chartDiv = document.createElement('div');
                chartDiv.style.height = '400px';
                chartDiv.style.overflow = 'auto';
                chartDiv.style.border = '1px solid #ddd';
                chartDiv.style.padding = '10px';
                chartDiv.style.fontFamily = 'monospace';
                chartDiv.style.fontSize = '12px';
                
                if (type === 'day' && item.day_data && item.day_data.length > 0) {
                    let dayText = "日期\t\t开盘价\t最高价\t最低价\t收盘价\n";
                    dayText += "----\t\t------\t------\t------\t------\n";
                    item.day_data.slice(-30).forEach(point => {  // 只显示最近30个数据点
                        dayText += `${point.date}\t${point.open.toFixed(2)}\t${point.high.toFixed(2)}\t${point.low.toFixed(2)}\t${point.close.toFixed(2)}\n`;
                    });
                    chartDiv.textContent = dayText;
                } else if (type === 'min' && item.min_data && item.min_data.length > 0) {
                    let minText = "时间\t\t\t波动率\n";
                    minText += "----\t\t\t------\n";
                    item.min_data.slice(-30).forEach(point => {  // 只显示最近30个数据点
                        minText += `${point.time}\t\t${point.qvix.toFixed(2)}\n`;
                    });
                    chartDiv.textContent = minText;
                } else {
                    chartDiv.textContent = '暂无数据';
                }
                
                container.appendChild(chartDiv);
            }
            
            // 更新期权K线图
            updateOptionsChart() {
                if (this.currentOptionsChart) {
                    this.showOptionsChart(this.currentOptionsChart);
                }
            }
            
            updateNewSignalsTable() {
                const tbody = document.getElementById('newSignalsBody');
                if (this.newSignals.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">暂无新信号</td></tr>';
                    return;
                }
                
                tbody.innerHTML = '';
                this.newSignals.forEach(signal => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="timestamp">${signal.timestamp}</td>
                        <td>${signal.code}</td>
                        <td>${signal.level}</td>
                        <td>${signal.price}</td>
                        <td>${signal.bsp_type}</td>
                        <td class="${signal.is_buy ? 'buy-signal' : 'sell-signal'}">
                            ${signal.operation}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            updateDisappearedSignalsTable() {
                const tbody = document.getElementById('disappearedSignalsBody');
                if (this.disappearedSignals.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">暂无消失信号</td></tr>';
                    return;
                }
                
                tbody.innerHTML = '';
                this.disappearedSignals.forEach(signal => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="timestamp">${signal.timestamp}</td>
                        <td>${signal.code}</td>
                        <td>${signal.level}</td>
                        <td>${signal.bsp_type}</td>
                        <td class="${signal.is_buy ? 'buy-signal' : 'sell-signal'}">
                            ${signal.operation}
                        </td>
                        <td>${signal.reason}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            // 发送配置更新到服务器
            sendConfigUpdate(config) {
                if (this.isConnected && this.ws.readyState === WebSocket.OPEN) {
                    const message = JSON.stringify({
                        type: "config_update",
                        ...config
                    });
                    this.ws.send(message);
                }
            }
        }
        
        // 更新WebSocket配置函数
        function updateWebSocketConfig(key, value) {
            // 更新UI状态显示
            const statusElement = document.getElementById(key + 'Status');
            if (statusElement) {
                statusElement.textContent = value ? '开启' : '关闭';
            }
            
            // 发送配置更新到服务器
            if (window.client) {
                const config = {};
                config[key] = value;
                window.client.sendConfigUpdate(config);
            }
        }
        
        // 页面加载完成后初始化WebSocket客户端
        document.addEventListener('DOMContentLoaded', () => {
            window.client = new ChanWebSocketClient();
        });
    </script>
</body>
</html>